<html>
	<head>
		<!--
			x, y, z === forward, up, right
		-->
		<link rel="stylesheet" href="styles/reset.css" />
		<style type="text/css">
			body {
				color: white;
				font-size: 20px;
				pointer-events: none;
				overflow: hidden;
				background-image: linear-gradient(
					0deg,
					black 0%,
					blue 100%
				);
			}
		</style>
		<script type="importmap">
			{
				"imports": {
					"three": "../node_modules/three/src/Three.js",
					"preact": "../node_modules/preact/dist/preact.module.js",
					"preact-hooks": "../node_modules/preact/hooks/dist/hooks.module.js",
					"jss": "../node_modules/jss/dist/jss.esm.js",
					"clsx": "../node_modules/clsx/dist/clsx.mjs"
			 	}
			}
		</script>
		<script type="module">
			import { render, h } from 'preact';

			import useLocalStorageValue from './hooks/useLocalStorageValue.js';

			import createFavicon from "./modules/createFavicon.js";
			import createKeyboardIntegrator from "./modules/createKeyboardIntegrator.js";

			import { useState, useEffect, useCallback } from 'preact-hooks';
			import SplashScreen from "./screens/SplashScreen.js";
			import MainMenuScreen from "./screens/MainMenuScreen.js";
			import LevelScreen from "./screens/LevelScreen.js";
			import PlayNextScreen from "./screens/PlayNextScreen.js";
			import GameEndScreen from "./screens/GameEndScreen.js";

			document.addEventListener('DOMContentLoaded', async (event) => {
				const MAIN_MENU_SCREEN = 'main-menu-screen';
				const LEVEL_SCREEN = 'level-screen';
				const PLAY_NEXT_SCREEN = 'play-next-screen';
				const GAME_END_SCREEN = 'game-end-screen';

				function App({ keyboardIntegrator }) {
					const [maxAccessibleLevel, setMaxAccessibleLevel] = useLocalStorageValue('max-accessible-level', 1);
					const [levelToLoad, setLevelToload] = useState(maxAccessibleLevel);
					const [activeItem, setActiveItem] = useState(MAIN_MENU_SCREEN);
					const handleSelectedItemId = useCallback((itemId) => {
						console.log('>> selected', itemId);
					}, []);

					const handleNewGame = useCallback(() => {
						setLevelToload(1);
						setActiveItem(LEVEL_SCREEN);
					}, []);

					const handleContinueGame = useCallback(() => {
						setLevelToload(maxAccessibleLevel);
						setActiveItem(LEVEL_SCREEN);
					}, [maxAccessibleLevel]);

					const handleOnLevelEnded = useCallback((endedLevel) => {
						if (endedLevel == 3) {
							setActiveItem(GAME_END_SCREEN);
						} else {
							setLevelToload(endedLevel + 1);
							setMaxAccessibleLevel(endedLevel + 1);
							setActiveItem(PLAY_NEXT_SCREEN);
						}
					}, []);

					const handleLoadNextLevel = useCallback(() => {
						setActiveItem(LEVEL_SCREEN);
					}, []);

					const handleEndScreenEnded = useCallback(() => {
						setActiveItem(MAIN_MENU_SCREEN);
					}, []);

					return h(SplashScreen, { elementId: 'splashscreen' }, [
						activeItem === MAIN_MENU_SCREEN && h(MainMenuScreen,
							{
								onSelectedItemId: handleSelectedItemId,
								items: [
									{ label: `continue game ${maxAccessibleLevel}`, onSelected: handleContinueGame },
									{ label: 'new game', onSelected: handleNewGame },
									{ label: 'settings' },
									{ label: 'quit' },
								]
							},
							[
							],
						),
						activeItem === LEVEL_SCREEN && h(LevelScreen,
							{
								levelNumber: levelToLoad,
								keyboardIntegrator,
								onLevelEnded: handleOnLevelEnded,
							},
						),
						activeItem === PLAY_NEXT_SCREEN && h(PlayNextScreen,
							{
								nextLevelNumber: maxAccessibleLevel,
								onYes: handleLoadNextLevel,
							},
						),
						activeItem === GAME_END_SCREEN && h(GameEndScreen,
							{
								onWatched: handleEndScreenEnded,
							},
						),
						// h(PauseManuScreen, { secret: 'orange' }, [
						// 	// h(MainMenu)
						// ]),
						// h(CreditsScreen, { secret: 'orange' }, [
						// 	// h(MainMenu)
						// ]),
					]);
				}

				const favicon = createFavicon({ width: 16, height: 16 });
				const keyboardIntegrator = createKeyboardIntegrator({});
				const mainElement = document.getElementById('main');

				render(h(App, { keyboardIntegrator }), mainElement);

				/*

				const splashscreen = createSplashscreen({
					keyboardIntegrator,
					shouldSkipIntro: true,
				});

				await splashscreen.waitUntilUserPressedAnyKey();

				splashscreen.destroy();

				const levelResult = await createLevel(1, { keyboardIntegrator });

				const screenEnded = createLevelEndedScreen({ keyboardIntegrator });

				await screenEnded.waitUntilUserPressedAnyKey();

				screenEnded.destroy();

				console.log('>> game ended', levelResult);
				*/
			});
		</script>
	</head>
	<body>
		<div id="main"></div>
		<div
			id="splashscreen"
			style="
				position: fixed;
				inset: 0;
				background-color: red;
				display: flex;
				justify-content: center;
				align-items: center;
				flex-direction: column;
			"
		>
			<div style="font-size: 3rem">
				LONESHIP
			</div>
			<div class="continue" style="opacity: 0;">
				press eny key to continue
			</div>
		</div>
	</body>
</html>
